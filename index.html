<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FlashCode IDE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg0:#0d0d0d;--bg1:#141414;--bg2:#1a1a1a;--bg3:#222;--bg4:#2a2a2a;
  --border:#2e2e2e;--text:#d4d4d4;--text2:#888;--text3:#555;
  --accent:#3b82f6;--accent2:#1d4ed8;--green:#22c55e;--red:#ef4444;
  --yellow:#eab308;--purple:#a855f7;
  --mono:'Fira Code','Cascadia Code',Consolas,monospace;
  --ui:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  --sw:44px;--sbw:240px;--ph:220px;--tbh:40px;--tbbh:36px;--sbh:24px;
}
html,body{height:100%;overflow:hidden;background:var(--bg0);color:var(--text);font-family:var(--ui);font-size:13px}

/* â”€â”€ AUTH â”€â”€ */
#auth{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:24px}
.auth-logo{display:flex;align-items:center;gap:12px}
.auth-logo svg{color:var(--accent)}
.auth-logo h1{font-size:28px;font-weight:700;letter-spacing:-.5px;color:#fff}
.auth-logo span{color:var(--accent)}
.auth-tag{color:var(--text2);font-size:14px}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:32px;display:flex;flex-direction:column;gap:16px;width:340px}
.auth-card h2{font-size:16px;font-weight:600;color:#fff}
.auth-card p{color:var(--text2);font-size:13px;line-height:1.5}
.btn-gh{display:flex;align-items:center;justify-content:center;gap:10px;background:#fff;color:#0d0d0d;border:none;border-radius:8px;padding:11px 16px;font-size:14px;font-weight:600;cursor:pointer;transition:background .15s}
.btn-gh:hover{background:#e5e5e5}

/* â”€â”€ IDE â”€â”€ */
#ide{display:none;flex-direction:column;height:100vh}
#ide.on{display:flex}

/* titlebar */
#tb{height:var(--tbh);background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0;user-select:none;position:relative}
.tb-logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;flex-shrink:0}
.tb-logo span{color:var(--accent)}
.tb-sep{width:1px;height:18px;background:var(--border);flex-shrink:0}
.repo-sel{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text);min-width:160px;max-width:220px}
.repo-sel:hover{border-color:var(--accent)}
#repo-lbl{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.br-badge{background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:11px;color:var(--accent);font-family:var(--mono);display:none;flex-shrink:0}
.tb-actions{margin-left:auto;display:flex;gap:6px;align-items:center;flex-shrink:0}
.btn-icon{background:none;border:none;color:var(--text2);cursor:pointer;padding:5px;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s;flex-shrink:0}
.btn-icon:hover{background:var(--bg4);color:var(--text)}
.btn-run{display:flex;align-items:center;gap:6px;background:var(--green);color:#000;border:none;border-radius:6px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity .15s;flex-shrink:0}
.btn-run:hover{opacity:.85}
.btn-run:disabled{opacity:.4;cursor:not-allowed}
.btn-commit{display:flex;align-items:center;gap:6px;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity .15s;flex-shrink:0}
.btn-commit:hover{opacity:.85}
.avatar{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);cursor:pointer;object-fit:cover;flex-shrink:0}
.umenu{position:absolute;top:calc(var(--tbh) + 4px);right:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;min-width:180px;z-index:500;display:none}
.umenu.on{display:block}
.umenu-item{padding:8px 12px;border-radius:5px;cursor:pointer;color:var(--text2);font-size:12px;transition:background .1s;display:flex;align-items:center;gap:8px}
.umenu-item:hover{background:var(--bg4);color:var(--text)}
.umenu-item.danger:hover{background:#3f1212;color:var(--red)}
.umenu-sep{height:1px;background:var(--border);margin:4px 0}

/* main */
#main{display:flex;flex:1;overflow:hidden}

/* activity bar */
#actbar{width:var(--sw);background:var(--bg0);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:4px;flex-shrink:0}
.act-btn{width:34px;height:34px;border-radius:7px;background:none;border:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s;position:relative}
.act-btn:hover,.act-btn.on{background:var(--bg3);color:var(--text)}
.act-btn.on{color:var(--accent)}
.act-btn[data-dot]::after{content:'';position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;background:var(--yellow)}

/* sidebar */
#sb{width:var(--sbw);background:var(--bg1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.sb-hdr{height:36px;display:flex;align-items:center;padding:0 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);border-bottom:1px solid var(--border);flex-shrink:0;justify-content:space-between}
#ftree{flex:1;overflow-y:auto;padding:4px 0}
#ftree::-webkit-scrollbar{width:4px}
#ftree::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.t-dir{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--text2);transition:background .1s,color .1s;white-space:nowrap;overflow:hidden;user-select:none;padding:3px 8px 3px 0}
.t-dir:hover{background:var(--bg3);color:var(--text)}
.t-dir svg.chev{flex-shrink:0;transition:transform .15s}
.t-dir.open svg.chev{transform:rotate(90deg)}
.t-file{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--text2);transition:background .1s,color .1s;white-space:nowrap;overflow:hidden;padding:3px 8px 3px 0}
.t-file:hover{background:var(--bg3);color:var(--text)}
.t-file.active{background:var(--bg4);color:#fff}
.t-file.mod::after{content:'â—';color:var(--yellow);margin-left:4px;font-size:8px}
.t-ch{display:none}
.t-ch.open{display:block}
.t-nm{overflow:hidden;text-overflow:ellipsis}
.sb-empty{padding:16px 12px;color:var(--text3);font-size:12px;line-height:1.6}

/* editor */
#ea{flex:1;display:flex;flex-direction:column;overflow:hidden}
#tabbar{height:var(--tbbh);background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:flex-end;overflow-x:auto;flex-shrink:0}
#tabbar::-webkit-scrollbar{height:0}
.tab{display:flex;align-items:center;gap:6px;padding:0 14px;height:100%;border-right:1px solid var(--border);font-size:12px;cursor:pointer;color:var(--text2);white-space:nowrap;background:var(--bg1);transition:background .1s,color .1s;flex-shrink:0;position:relative}
.tab:hover{background:var(--bg2);color:var(--text)}
.tab.active{background:var(--bg2);color:#fff}
.tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent)}
.tab.mod::before{content:'â—';color:var(--yellow);margin-right:-4px;font-size:10px}
.tab-x{width:16px;height:16px;border-radius:3px;border:none;background:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;line-height:1;transition:background .1s,color .1s}
.tab-x:hover{background:var(--bg4);color:var(--text)}
#no-tabs{display:flex;align-items:center;padding:0 16px;color:var(--text3);font-size:12px}

/* editor panel */
#epc{flex:1;display:flex;flex-direction:column;overflow:hidden}
#ec{flex:1;overflow:hidden;position:relative;display:flex;flex-direction:column}
#me{flex:1}
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;color:var(--text3)}
#welcome h2{font-size:20px;color:var(--text2)}
#welcome p{font-size:13px;line-height:1.6;text-align:center;max-width:360px}
#welcome kbd{background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-family:var(--mono);font-size:11px;color:var(--text2)}
/* FULL PREVIEW â€” covers editor area entirely, no sidebar */
#preview-wrap{position:absolute;inset:0;background:#fff;display:none;flex-direction:column;z-index:10}
#preview-wrap.on{display:flex}
#preview-toolbar{background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:0 12px;height:34px;flex-shrink:0}
#preview-url{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:3px 8px;color:var(--text);font-size:12px;font-family:var(--mono);outline:none}
#preview-frame{flex:1;border:none;background:#fff}

/* bottom panel */
#bp{background:var(--bg1);border-top:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;height:var(--ph)}
#bp.hidden{display:none}
.p-tabs{display:flex;border-bottom:1px solid var(--border);height:32px;flex-shrink:0;align-items:center}
.p-tab{display:flex;align-items:center;gap:6px;padding:0 14px;font-size:12px;color:var(--text3);cursor:pointer;border-right:1px solid var(--border);height:100%;transition:background .1s,color .1s}
.p-tab:hover{background:var(--bg2);color:var(--text2)}
.p-tab.active{color:var(--text);background:var(--bg2)}
.p-acts{margin-left:auto;display:flex;align-items:center;padding:0 8px;gap:4px}
.p-content{flex:1;overflow:hidden;display:none;flex-direction:column}
.p-content.active{display:flex}
#term{flex:1;overflow-y:auto;padding:10px 14px;font-family:var(--mono);font-size:12px;line-height:1.6;background:var(--bg0)}
#term::-webkit-scrollbar{width:4px}
#term::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.tl{white-space:pre-wrap;word-break:break-all}
.ti{color:var(--text2)}.ts{color:var(--green)}.te{color:var(--red)}.tw{color:var(--yellow)}.tp{color:var(--accent)}.to{color:var(--text)}
#tinr{display:flex;align-items:center;gap:8px;padding:6px 14px;border-top:1px solid var(--border);background:var(--bg0)}
#tprompt{color:var(--accent);font-family:var(--mono);font-size:12px}
#tinput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:12px}
/* AI */
#ai-wrap{flex:1;display:flex;flex-direction:column;background:var(--bg0);overflow:hidden}
#ai-msgs{flex:1;overflow-y:auto;padding:10px 14px;display:flex;flex-direction:column;gap:10px}
#ai-msgs::-webkit-scrollbar{width:4px}
#ai-msgs::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.am{display:flex;gap:8px}
.am-av{width:24px;height:24px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
.am.user .am-av{background:var(--accent);color:#fff}
.am.assistant .am-av{background:var(--purple);color:#fff}
.am-b{flex:1;min-width:0}
.am-r{font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text3);margin-bottom:2px}
.am-t{font-size:12px;line-height:1.6;color:var(--text);white-space:pre-wrap;word-break:break-word}
.am-t code{font-family:var(--mono);background:var(--bg3);padding:1px 4px;border-radius:3px;font-size:11px}
.am-t pre{overflow-x:auto}
#ai-inp-row{display:flex;gap:8px;padding:8px 14px;border-top:1px solid var(--border);background:var(--bg1);flex-shrink:0}
#ai-inp{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--ui);resize:none;height:34px;line-height:1.4}
#ai-inp:focus{border-color:var(--accent)}
.btn-send{background:var(--accent);border:none;border-radius:6px;color:#fff;width:34px;height:34px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .15s}
.btn-send:hover{opacity:.85}
.btn-send:disabled{opacity:.4;cursor:not-allowed}

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center}
.modal.on{display:flex}
.mbox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:500px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.mbox.wide{width:580px}
.mhdr{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.mhdr h3{font-size:15px;font-weight:600}
.mbody{padding:16px 20px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
.mbody p{color:var(--text2);font-size:12px}
.mftr{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0}
.btn-cancel{background:var(--bg4);border:1px solid var(--border);color:var(--text2);border-radius:6px;padding:7px 14px;cursor:pointer;font-size:13px}
.btn-cancel:hover{color:var(--text)}
.btn-ok{background:var(--accent);border:none;color:#fff;border-radius:6px;padding:7px 14px;cursor:pointer;font-size:13px;font-weight:600}
.btn-ok:hover{opacity:.85}
/* repo search */
#repo-search{margin:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;width:calc(100% - 32px)}
#repo-search:focus{border-color:var(--accent)}
#repo-list{overflow-y:auto;padding:4px 8px 8px}
#repo-list::-webkit-scrollbar{width:4px}
#repo-list::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.ri{display:flex;flex-direction:column;padding:10px 12px;border-radius:7px;cursor:pointer;transition:background .1s}
.ri:hover{background:var(--bg3)}
.ri-n{font-size:13px;color:#fff;font-weight:500}
.ri-m{font-size:11px;color:var(--text3);margin-top:2px}
/* form fields */
.field{display:flex;flex-direction:column;gap:5px}
.field label{font-size:12px;color:var(--text2);font-weight:500}
.field input,.field select,.field textarea{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;color:var(--text);font-size:13px;outline:none;font-family:var(--ui)}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent)}
.field select option{background:var(--bg3)}
.field textarea{resize:vertical;min-height:70px}
.field .hint{font-size:11px;color:var(--text3)}
/* API key group */
.provider-section{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px;display:flex;flex-direction:column;gap:10px}
.provider-section h4{font-size:12px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
.provider-badge{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
.key-row{display:flex;gap:8px;align-items:center}
.key-row input{flex:1;background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--mono)}
.key-row input:focus{border-color:var(--accent)}
.key-row .btn-icon{background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text2)}

/* commit modal extras */
.commit-summary{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:12px;max-height:200px;overflow-y:auto;margin-top:8px}
.commit-summary::-webkit-scrollbar{width:4px}
.commit-summary::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.cf-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;color:var(--text2)}
.cf-item.mod{color:var(--yellow)}
.cf-item svg{flex-shrink:0}

/* statusbar */
#statusbar{height:var(--sbh);background:var(--accent2);display:flex;align-items:center;padding:0 12px;gap:16px;font-size:11px;color:rgba(255,255,255,.8);flex-shrink:0;user-select:none}
.si{display:flex;align-items:center;gap:5px}
.si.r{margin-left:auto}
.lang-pill{font-size:10px;padding:1px 6px;border-radius:10px;font-family:var(--mono);font-weight:600}

/* resize */
#rh{height:4px;background:transparent;cursor:row-resize;flex-shrink:0;border-top:1px solid var(--border)}
#rh:hover{background:var(--accent)}

/* notifs */
#notif{position:fixed;bottom:32px;right:16px;z-index:600;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.ni{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:sIn .2s ease;max-width:300px}
.ni.s{border-color:var(--green)}.ni.e{border-color:var(--red)}.ni.w{border-color:var(--yellow)}
@keyframes sIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{animation:spin .8s linear infinite;display:inline-block}
</style>
</head>
<body>

<!-- â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth">
  <div class="auth-logo">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
    <h1>Flash<span>Code</span></h1>
  </div>
  <p class="auth-tag">Browser IDE Â· GitHub Â· WebAssembly Â· AI</p>
  <div class="auth-card">
    <h2>Sign in to continue</h2>
    <p>Connect your GitHub account to browse repos, edit code, and run it instantly in your browser.</p>
    <button class="btn-gh" onclick="signIn()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      Continue with GitHub
    </button>
  </div>
</div>

<!-- â•â• IDE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ide">

  <!-- Titlebar -->
  <div id="tb">
    <div class="tb-logo"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Flash<span>Code</span></div>
    <div class="tb-sep"></div>
    <div class="repo-sel" onclick="openRepoModal()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
      <span id="repo-lbl">Open a repositoryâ€¦</span>
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <span class="br-badge" id="br-badge">main</span>
    <div class="tb-actions">
      <button class="btn-run" id="run-btn" onclick="runCode()" disabled title="Run (Ctrl+Enter)">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>Run
      </button>
      <button class="btn-commit" id="commit-btn" onclick="openCommitModal()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><line x1="12" y1="1" x2="12" y2="9"/><line x1="12" y1="15" x2="12" y2="23"/><line x1="1" y1="12" x2="9" y2="12"/><line x1="15" y1="12" x2="23" y2="12"/></svg>Commit
      </button>
      <button class="btn-icon" onclick="togglePanel()" title="Toggle terminal">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
      </button>
      <img class="avatar" id="u-av" src="" alt="" onclick="toggleUMenu()"/>
    </div>
  </div>

  <!-- User menu -->
  <div class="umenu" id="umenu">
    <div class="umenu-item" id="u-name" style="color:var(--text);font-weight:500;cursor:default"></div>
    <div class="umenu-sep"></div>
    <div class="umenu-item" onclick="openSettings()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings & API Keys
    </div>
    <div class="umenu-item danger" onclick="signOut()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign out
    </div>
  </div>

  <div id="main">
    <!-- Activity bar -->
    <div id="actbar">
      <button class="act-btn on" title="Explorer" onclick="setAct(this,'explorer')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      </button>
      <button class="act-btn" title="AI Assistant" onclick="setAct(this,'ai')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </button>
      <button class="act-btn" title="Preview" onclick="setAct(this,'preview')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      </button>
    </div>

    <!-- Sidebar -->
    <div id="sb">
      <div class="sb-hdr">
        <span>Explorer</span>
        <button class="btn-icon" onclick="refreshTree()" style="padding:2px" title="Refresh">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </button>
      </div>
      <div id="ftree"><div class="sb-empty">Open a repository to browse files.</div></div>
    </div>

    <!-- Editor area -->
    <div id="ea">
      <div id="tabbar"><span id="no-tabs">No files open</span></div>
      <div id="epc">
        <div id="ec">
          <!-- Full-screen preview overlay (covers editor+panel) -->
          <div id="preview-wrap">
            <div id="preview-toolbar">
              <button class="btn-icon" onclick="closePreview()" title="Back to editor">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <span style="font-size:12px;color:var(--text2);font-family:var(--mono)" id="preview-title">Preview</span>
              <div style="flex:1"></div>
              <button class="btn-icon" onclick="reloadPreview()" title="Reload">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
              </button>
            </div>
            <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin allow-forms" title="Preview"></iframe>
          </div>

          <div id="welcome">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text3)"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            <h2>FlashCode</h2>
            <p>Open a repository, click a file to start editing.<br/>Press <kbd>â–¶ Run</kbd> to execute in the browser.</p>
          </div>
          <div id="me" style="display:none;height:100%"></div>
        </div>

        <div id="rh"></div>

        <div id="bp">
          <div class="p-tabs">
            <div class="p-tab active" id="pt-terminal" onclick="switchPanel('terminal')">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Terminal
            </div>
            <div class="p-tab" id="pt-ai" onclick="switchPanel('ai')">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>AI Assistant
            </div>
            <div class="p-acts">
              <button class="btn-icon" onclick="clearTerm()" title="Clear terminal">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg>
              </button>
              <button class="btn-icon" onclick="togglePanel()" title="Close panel">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
          </div>
          <div class="p-content active" id="pc-terminal">
            <div id="term"></div>
            <div id="tinr"><span id="tprompt">â¯</span><input id="tinput" placeholder="Python REPLâ€¦" onkeydown="tKeyDown(event)" autocomplete="off" spellcheck="false"/></div>
          </div>
          <div class="p-content" id="pc-ai">
            <div id="ai-wrap">
              <div id="ai-msgs">
                <div class="am assistant">
                  <div class="am-av">AI</div>
                  <div class="am-b"><div class="am-r">Assistant</div>
                  <div class="am-t">Hi! I'm your AI coding assistant. I can see your entire repository structure and file contents. Add your API key in Settings, then ask me anything!</div></div>
                </div>
              </div>
              <div id="ai-inp-row">
                <textarea id="ai-inp" placeholder="Ask about your codeâ€¦ (Enter to send)" onkeydown="aiKey(event)"></textarea>
                <button class="btn-send" onclick="sendAI()" id="ai-send">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="statusbar">
    <div class="si"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg><span id="s-repo">No repo</span></div>
    <div class="si"><span id="s-file" style="color:var(--text3)">No file</span></div>
    <div class="si"><span id="s-lang"></span></div>
    <div class="si r" id="s-runtime"><span class="spin">âŸ³</span> Loading Pythonâ€¦</div>
  </div>
</div>

<!-- â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Repo picker -->
<div class="modal" id="modal-repo">
  <div class="mbox">
    <div class="mhdr"><h3>Open Repository</h3>
      <button class="btn-icon" onclick="closeModal('repo')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <input id="repo-search" placeholder="Search repositoriesâ€¦" oninput="filterRepos()"/>
    <div id="repo-list"></div>
  </div>
</div>

<!-- Commit -->
<div class="modal" id="modal-commit">
  <div class="mbox">
    <div class="mhdr"><h3>Commit & Push Changes</h3>
      <button class="btn-icon" onclick="closeModal('commit')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="mbody">
      <p>Modified files:</p>
      <div class="commit-summary" id="commit-files"></div>
      <div class="field"><label>Commit message</label><textarea class="modal-ta" id="commit-msg" style="background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:10px;color:var(--text);font-size:13px;outline:none;resize:vertical;min-height:70px;font-family:var(--ui)" placeholder="Describe your changesâ€¦"></textarea></div>
    </div>
    <div class="mftr">
      <button class="btn-cancel" onclick="closeModal('commit')">Cancel</button>
      <button class="btn-ok" onclick="doCommitAll()" id="commit-ok-btn">Commit & Push</button>
    </div>
  </div>
</div>

<!-- Settings / API Keys -->
<div class="modal" id="modal-settings">
  <div class="mbox wide">
    <div class="mhdr"><h3>Settings & API Keys</h3>
      <button class="btn-icon" onclick="closeModal('settings')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="mbody">
      <p style="line-height:1.6">Your API keys are stored in your browser's localStorage. They are never sent to any server except the AI provider you select.</p>

      <div class="field">
        <label>Default AI Provider</label>
        <select id="cfg-provider">
          <option value="claude">Claude (Anthropic)</option>
          <option value="openai">OpenAI (GPT)</option>
          <option value="gemini">Gemini (Google)</option>
          <option value="grok">Grok (xAI)</option>
          <option value="groq">Groq (Llama)</option>
          <option value="openrouter">OpenRouter</option>
        </select>
      </div>

      <div class="field">
        <label>Default Model <span class="hint">(leave blank for default)</span></label>
        <input type="text" id="cfg-model" placeholder="e.g. claude-sonnet-4-20250514, gpt-4o, gemini-2.0-flashâ€¦"/>
      </div>

      <div class="provider-section">
        <h4><span style="color:#a78bfa">â—†</span> Claude â€” Anthropic <a href="https://console.anthropic.com/keys" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-claude" placeholder="sk-ant-â€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-claude')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div class="provider-section">
        <h4><span style="color:#4ade80">â—†</span> OpenAI <a href="https://platform.openai.com/api-keys" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-openai" placeholder="sk-â€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-openai')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div class="provider-section">
        <h4><span style="color:#60a5fa">â—†</span> Gemini â€” Google <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-gemini" placeholder="AIzaâ€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-gemini')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div class="provider-section">
        <h4><span style="color:#f87171">â—†</span> Grok â€” xAI <a href="https://console.x.ai/" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-grok" placeholder="xai-â€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-grok')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div class="provider-section">
        <h4><span style="color:#fb923c">â—†</span> Groq (Llama) <a href="https://console.groq.com/keys" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-groq" placeholder="gsk_â€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-groq')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div class="provider-section">
        <h4><span style="color:#e879f9">â—†</span> OpenRouter <a href="https://openrouter.ai/keys" target="_blank" style="font-size:10px;color:var(--accent);margin-left:auto;font-weight:400">Get key â†—</a></h4>
        <div class="key-row">
          <input type="password" id="key-openrouter" placeholder="sk-or-â€¦"/>
          <button class="btn-icon" onclick="toggleKeyVis('key-openrouter')" title="Show/hide"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
    </div>
    <div class="mftr">
      <button class="btn-cancel" onclick="closeModal('settings')">Cancel</button>
      <button class="btn-ok" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<div id="notif"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://uvslkqxtkortoiacmknw.supabase.co';
const SB_KEY = 'sb_publishable_7kz7TnR6P4cwRVlr7C_0bA_iqtTVwiF';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let session=null, ghToken=null, curRepo=null, curBranch='main';
let tabs=[], activeTab=null, editor=null;
let pyodide=null, pyReady=false;
let allRepos=[], aiHistory=[];
let panelVisible=true;
let userSettings={}; // { provider, model, keys:{claude,openai,...} }
let repoTree=[]; // flat tree items
let vfs={}; // Virtual File System: { 'path/to/file.py': 'content' }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANG / ICON MAPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_MAP={py:'python',js:'javascript',ts:'typescript',jsx:'javascript',tsx:'typescript',json:'json',md:'markdown',css:'css',html:'html',sh:'shell',yml:'yaml',yaml:'yaml',rs:'rust',go:'go',java:'java',c:'c',cpp:'cpp',cs:'csharp',rb:'ruby',php:'php',vue:'html',svelte:'html',kt:'kotlin',swift:'swift',sql:'sql',graphql:'graphql',toml:'ini',xml:'xml',txt:'plaintext'};
const ICON_MAP={py:'ğŸ',js:'âš¡',ts:'ğŸ”·',jsx:'âš›',tsx:'âš›',json:'{}',md:'ğŸ“',css:'ğŸ¨',html:'ğŸŒ',yml:'âš™',yaml:'âš™',sh:'ğŸ’»',rs:'ğŸ¦€',go:'ğŸ¹',java:'â˜•',rb:'ğŸ’',php:'ğŸ˜',vue:'ğŸ’š',svelte:'ğŸ§¡',sql:'ğŸ—„',xml:'ğŸ“‹',txt:'ğŸ“„',toml:'âš™',env:'ğŸ”',lock:'ğŸ”’'};
const LANG_COLORS={python:'#3b82f6',javascript:'#eab308',typescript:'#3b82f6',html:'#f97316',css:'#a855f7',rust:'#f97316',go:'#22c55e',ruby:'#ef4444',java:'#f97316'};
const RUNNABLE=new Set(['python','javascript','typescript','html']);

function langFrom(p=''){const e=p.split('.').pop()?.toLowerCase();return LANG_MAP[e]||'plaintext';}
function iconFrom(p=''){const e=p.split('.').pop()?.toLowerCase();return ICON_MAP[e]||'ğŸ“„';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VFS â€” Virtual File System for code execution
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncVFS(){
  // Sync all loaded tabs into VFS
  vfs={};
  tabs.forEach(t=>{
    // Update from editor if it's the active tab
    if(t===activeTab&&editor){
      t.content=editor.getValue();
    }
    vfs[t.path]=t.content;
  });
}

async function loadAllFilesIntoVFS(){
  // Load ALL repository files into VFS for proper imports/requires
  if(!curRepo||!repoTree.length)return;
  
  tLog('Loading repository into virtual file systemâ€¦','i');
  const[owner,repo]=curRepo.split('/');
  let loaded=0;
  
  for(const item of repoTree){
    if(item.type!=='blob')continue;
    
    // Skip if already in tabs
    if(tabs.some(t=>t.path===item.path))continue;
    
    // Only load text files (skip binaries)
    const ext=item.path.split('.').pop()?.toLowerCase();
    if(['png','jpg','jpeg','gif','svg','ico','woff','woff2','ttf','eot','zip','tar','gz','pdf'].includes(ext))continue;
    
    try{
      const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${item.path}?ref=${curBranch}`,{headers:ghH()});
      if(!r.ok)continue;
      const d=await r.json();
      try{
        const content=decodeURIComponent(escape(atob(d.content.replace(/\n/g,''))));
        vfs[item.path]=content;
        loaded++;
      }catch{}
    }catch{}
  }
  
  // Sync current tabs
  syncVFS();
  tLog(`Loaded ${loaded} files + ${tabs.length} open files into VFS.`,'s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  const hash=window.location.hash;
  if(hash){
    const p=new URLSearchParams(hash.slice(1));
    const at=p.get('access_token'),pt=p.get('provider_token');
    if(at){session={access_token:at};ghToken=pt;history.replaceState(null,'',location.pathname);await loadUser();return;}
  }
  const stored=sessionStorage.getItem('fc_s');
  if(stored){try{const s=JSON.parse(stored);session=s.s;ghToken=s.g;await loadUser();return;}catch{}}
  showAuth();
}
async function loadUser(){
  const r=await fetch(`${SB_URL}/auth/v1/user`,{headers:{apikey:SB_KEY,Authorization:`Bearer ${session.access_token}`}}).catch(()=>null);
  if(!r||!r.ok){showAuth();return;}
  const u=await r.json();
  sessionStorage.setItem('fc_s',JSON.stringify({s:session,g:ghToken}));
  document.getElementById('u-av').src=u.user_metadata?.avatar_url||'';
  document.getElementById('u-name').textContent=u.user_metadata?.full_name||u.email;
  showIDE();
  await loadSettings();
  initMonaco();
  loadPyodide();
}
function showAuth(){document.getElementById('auth').style.display='flex';document.getElementById('ide').classList.remove('on');}
function showIDE(){document.getElementById('auth').style.display='none';document.getElementById('ide').classList.add('on');}
function signIn(){const r=encodeURIComponent(location.href.split('#')[0]);location.href=`${SB_URL}/auth/v1/authorize?provider=github&redirect_to=${r}&scopes=repo`;}
async function signOut(){
  await fetch(`${SB_URL}/auth/v1/logout`,{method:'POST',headers:{apikey:SB_KEY,Authorization:`Bearer ${session.access_token}`}}).catch(()=>{});
  sessionStorage.removeItem('fc_s');localStorage.removeItem('fc_settings');session=null;ghToken=null;
  document.getElementById('umenu').classList.remove('on');
  showAuth();
}
function toggleUMenu(){document.getElementById('umenu').classList.toggle('on');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS â€” localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings(){
  try{
    const stored=localStorage.getItem('fc_settings');
    if(stored){userSettings=JSON.parse(stored);}
  }catch(e){console.error('Load settings error:',e);}
  updateAIBadge();
}
async function saveSettings(){
  const s={
    provider:document.getElementById('cfg-provider').value,
    model:document.getElementById('cfg-model').value.trim(),
    keys:{
      claude:document.getElementById('key-claude').value.trim(),
      openai:document.getElementById('key-openai').value.trim(),
      gemini:document.getElementById('key-gemini').value.trim(),
      grok:document.getElementById('key-grok').value.trim(),
      groq:document.getElementById('key-groq').value.trim(),
      openrouter:document.getElementById('key-openrouter').value.trim(),
    }
  };
  try{
    localStorage.setItem('fc_settings',JSON.stringify(s));
    userSettings=s;
    closeModal('settings');
    notify('Settings saved locally','s');
    updateAIBadge();
  }catch(e){
    notify('Failed to save settings: '+e.message,'e');
  }
}
function openSettings(){
  document.getElementById('umenu').classList.remove('on');
  document.getElementById('cfg-provider').value=userSettings.provider||'claude';
  document.getElementById('cfg-model').value=userSettings.model||'';
  const keys=userSettings.keys||{};
  ['claude','openai','gemini','grok','groq','openrouter'].forEach(p=>{
    const el=document.getElementById('key-'+p);
    if(el)el.value=keys[p]||'';
  });
  document.getElementById('modal-settings').classList.add('on');
}
function toggleKeyVis(id){
  const el=document.getElementById(id);
  el.type=el.type==='password'?'text':'password';
}
function updateAIBadge(){
  const p=userSettings.provider||'claude';
  const hasKey=!!(userSettings.keys?.[p]);
  const btn=document.querySelector('.act-btn[title="AI Assistant"]');
  if(btn){
    if(hasKey){delete btn.dataset.dot;}
    else{btn.dataset.dot='1';}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMonaco(){
  require.config({paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'}});
  require(['vs/editor/editor.main'],()=>{
    monaco.editor.defineTheme('fc',{
      base:'vs-dark',inherit:true,
      rules:[{token:'comment',foreground:'6a9955'},{token:'keyword',foreground:'569cd6',fontStyle:'bold'},{token:'string',foreground:'ce9178'},{token:'number',foreground:'b5cea8'}],
      colors:{'editor.background':'#141414','editor.lineHighlightBackground':'#1a1a1a','editorLineNumber.foreground':'#444','editorLineNumber.activeForeground':'#888','editor.selectionBackground':'#264f78'}
    });
    editor=monaco.editor.create(document.getElementById('me'),{
      theme:'fc',language:'plaintext',fontSize:13,
      fontFamily:"'Fira Code','Cascadia Code',Consolas,monospace",
      fontLigatures:true,lineHeight:20,minimap:{enabled:false},
      scrollBeyondLastLine:false,smoothScrolling:true,cursorBlinking:'smooth',
      wordWrap:'on',automaticLayout:true,
    });
    editor.onDidChangeModelContent(()=>{
      if(activeTab){
        activeTab.content=editor.getValue();
        activeTab.mod=true;
        renderTabs();
        updateFileTreeMod();
        syncCommitBtn();
        syncVFS();
      }
    });
    editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS,openCommitModal);
    editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.Enter,runCode);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PYODIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPyodide(){
  tLog('Loading Python 3.11 (WebAssembly)â€¦','i');
  try{
    const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';document.head.appendChild(s);
    await new Promise((res,rej)=>{s.onload=res;s.onerror=rej;});
    pyodide=await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/'});
    pyReady=true;
    document.getElementById('s-runtime').innerHTML='<span style="color:var(--green)">â—</span> Python 3.11 (WASM)';
    tLog('Python 3.11 ready.','s');
    syncRunBtn();
  }catch(e){
    document.getElementById('s-runtime').innerHTML='<span style="color:var(--red)">â—</span> Python unavailable';
    tLog('Python load failed: '+e.message,'e');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERMINAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLS_MAP={i:'ti',s:'ts',e:'te',w:'tw',p:'tp',o:'to'};
function tLog(txt,cls='o'){
  const d=document.createElement('div');d.className='tl '+(CLS_MAP[cls]||'to');d.textContent=txt;
  document.getElementById('term').appendChild(d);document.getElementById('term').scrollTop=9999;
}
function clearTerm(){document.getElementById('term').innerHTML='';}
function tKeyDown(e){if(e.key==='Enter'){const v=e.target.value.trim();if(!v)return;tLog('â¯ '+v,'p');e.target.value='';execPy(v);}}
async function execPy(code){
  if(!pyReady){tLog('Python not ready yet.','w');return;}
  try{
    pyodide.runPython(`import sys,io\n_o,_e=sys.stdout,sys.stderr\nsys.stdout=io.StringIO()\nsys.stderr=io.StringIO()`);
    try{pyodide.runPython(code);}
    catch(err){pyodide.runPython(`sys.stdout=_o;sys.stderr=_e`);tLog(err.message,'e');return;}
    const out=pyodide.runPython(`_s=sys.stdout.getvalue();sys.stdout=_o;sys.stderr=_e;_s`);
    if(out)tLog(out.trimEnd(),'o');else tLog('âœ“','s');
  }catch(err){tLog(err.message,'e');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN CODE â€” with VFS support
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runCode(){
  if(!activeTab)return;
  const code=editor?editor.getValue():activeTab.content;
  const lang=activeTab.lang;

  // Sync VFS before running
  syncVFS();

  if(lang==='html'){
    const hasIndex=tabs.some(t=>t.path.split('/').pop()==='index.html')||
      repoTree.some(f=>f.path==='index.html'||f.path.endsWith('/index.html'));
    if(activeTab.path.split('/').pop()==='index.html'||hasIndex){
      openRepoPreview();
    }else{
      openInlinePreview(code,activeTab.path);
    }
    return;
  }
  
  if(lang==='python'){
    if(!panelVisible)togglePanel();
    switchPanel('terminal');
    tLog(`\nâ–¶ Running ${activeTab.path}â€¦`,'i');
    
    // Mount VFS into Pyodide
    try{
      // Create a virtual filesystem in Pyodide
      for(const[path,content]of Object.entries(vfs)){
        const dir=path.split('/').slice(0,-1).join('/');
        if(dir){
          pyodide.runPython(`
import os
os.makedirs('${dir}', exist_ok=True)
`);
        }
        // Write file
        pyodide.FS.writeFile(path,content);
      }
      tLog(`Mounted ${Object.keys(vfs).length} files into VFS.`,'i');
    }catch(e){
      tLog('VFS mount warning: '+e.message,'w');
    }
    
    await execPy(code);
    return;
  }
  
  if(lang==='javascript'||lang==='typescript'){
    if(!panelVisible)togglePanel();
    switchPanel('terminal');
    tLog(`\nâ–¶ Running ${activeTab.path}â€¦`,'i');
    
    // Create a simple require() system for JavaScript
    const vfsContext=Object.entries(vfs).map(([p,c])=>`['${p}']:${JSON.stringify(c)}`).join(',');
    
    try{
      const wrapped=`
const _vfs={${vfsContext}};
const _log=(...a)=>postMessage({type:'log',data:a.join(' ')});
const _err=(...a)=>postMessage({type:'err',data:a.join(' ')});
const console={log:_log,error:_err,warn:_log,info:_log,debug:_log};
const require=(path)=>{
  if(_vfs[path])return eval(_vfs[path]);
  if(_vfs[path+'.js'])return eval(_vfs[path+'.js']);
  throw new Error('Cannot find module: '+path);
};
try{${code}}catch(e){_err(e.message)}`;
      const blob=new Blob([wrapped],{type:'text/javascript'});
      const url=URL.createObjectURL(blob);
      const w=new Worker(url);
      w.onmessage=e=>{tLog(e.data.data,e.data.type==='err'?'e':'o');};
      w.onerror=e=>tLog(e.message,'e');
      setTimeout(()=>{w.terminate();URL.revokeObjectURL(url);},15000);
    }catch(e){tLog(e.message,'e');}
    return;
  }
  
  tLog(`Cannot run ${lang} files in the browser.`,'w');
  if(!panelVisible)togglePanel();
  switchPanel('terminal');
}

// â”€â”€ Preview helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openInlinePreview(html,title){
  document.getElementById('preview-title').textContent=title||'Preview';
  document.getElementById('preview-frame').srcdoc=html;
  document.getElementById('preview-wrap').classList.add('on');
}

function openRepoPreview(){
  const indexTab=tabs.find(t=>t.path.split('/').pop()==='index.html')
    ||repoTree.find(f=>f.path.split('/').pop()==='index.html');

  if(!indexTab){notify('Load index.html first by clicking it in the file tree.','w');return;}

  let html=indexTab.content||(editor&&activeTab?.path===indexTab.path?editor.getValue():'');
  if(!html){notify('Open index.html in editor first.','w');return;}

  document.getElementById('preview-title').textContent=curRepo+' â€” index.html';
  document.getElementById('preview-frame').srcdoc=html;
  document.getElementById('preview-wrap').classList.add('on');
  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('on'));
  document.querySelector('.act-btn[title="Preview"]').classList.add('on');
}

function closePreview(){
  document.getElementById('preview-wrap').classList.remove('on');
  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('on'));
  document.querySelector('.act-btn[title="Explorer"]').classList.add('on');
}
function reloadPreview(){
  const f=document.getElementById('preview-frame');
  const src=f.srcdoc;f.srcdoc='';setTimeout(()=>f.srcdoc=src,50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ghH(){return{Authorization:`Bearer ${ghToken}`,Accept:'application/vnd.github+json'};}

async function openRepoModal(){
  document.getElementById('modal-repo').classList.add('on');
  document.getElementById('repo-search').value='';
  if(!ghToken){document.getElementById('repo-list').innerHTML='<div style="padding:16px;color:var(--red);font-size:12px">No GitHub token â€” please sign in again.</div>';return;}
  document.getElementById('repo-list').innerHTML='<div style="padding:16px;color:var(--text3);font-size:12px"><span class="spin">âŸ³</span> Loadingâ€¦</div>';
  const r=await fetch('https://api.github.com/user/repos?per_page=100&sort=updated',{headers:ghH()});
  allRepos=r.ok?await r.json():[];
  renderRepoList(allRepos);
}
function closeModal(n){document.getElementById('modal-'+n).classList.remove('on');}
function renderRepoList(repos){
  const el=document.getElementById('repo-list');
  if(!repos.length){el.innerHTML='<div style="padding:16px;color:var(--text3);font-size:12px">No repositories found.</div>';return;}
  el.innerHTML=repos.map(r=>`<div class="ri" onclick="selectRepo('${r.full_name}','${r.default_branch||'main'}')">
    <div class="ri-n">${r.name}</div>
    <div class="ri-m">${r.full_name} Â· ${r.private?'ğŸ”’ Private':'ğŸŒ Public'}${r.language?' Â· '+r.language:''}</div></div>`).join('');
}
function filterRepos(){
  const q=document.getElementById('repo-search').value.toLowerCase();
  renderRepoList(allRepos.filter(r=>r.full_name.toLowerCase().includes(q)));
}
async function selectRepo(full,branch){
  closeModal('repo');curRepo=full;curBranch=branch||'main';
  document.getElementById('repo-lbl').textContent=full;
  document.getElementById('s-repo').textContent=full;
  const bb=document.getElementById('br-badge');bb.style.display='flex';bb.textContent=curBranch;
  await refreshTree();
  // Load entire repo into VFS
  await loadAllFilesIntoVFS();
}
async function refreshTree(){
  if(!curRepo)return;
  const[owner,repo]=curRepo.split('/');
  document.getElementById('ftree').innerHTML='<div class="sb-empty"><span class="spin">âŸ³</span> Loadingâ€¦</div>';
  const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${curBranch}?recursive=1`,{headers:ghH()});
  if(!r.ok){document.getElementById('ftree').innerHTML='<div class="sb-empty" style="color:var(--red)">Failed to load tree.</div>';return;}
  const data=await r.json();
  repoTree=data.tree||[];
  buildTree(repoTree);
}

// â”€â”€ Collapsible tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTree(items){
  const root={c:{},f:[]};
  items.filter(i=>i.type==='blob').forEach(item=>{
    const parts=item.path.split('/');let node=root;
    for(let i=0;i<parts.length-1;i++){
      const p=parts[i];
      if(!node.c[p])node.c[p]={c:{},f:[],path:parts.slice(0,i+1).join('/')};
      node=node.c[p];
    }
    node.f.push({name:parts[parts.length-1],path:item.path});
  });
  const el=document.getElementById('ftree');el.innerHTML='';
  renderNode(root,el,0);
}
function renderNode(node,container,depth){
  const pad=(depth*14+8)+'px';
  // Dirs
  Object.keys(node.c).sort().forEach(name=>{
    const child=node.c[name];
    const dir=document.createElement('div');dir.className='t-dir';dir.style.paddingLeft=pad;
    dir.innerHTML=`<svg class="chev" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg><span>ğŸ“</span><span class="t-nm">${name}</span>`;
    const kids=document.createElement('div');kids.className='t-ch';
    dir.onclick=()=>{dir.classList.toggle('open');kids.classList.toggle('open');};
    container.appendChild(dir);container.appendChild(kids);
    renderNode(child,kids,depth+1);
  });
  // Files
  node.f.sort((a,b)=>a.name.localeCompare(b.name)).forEach(f=>{
    const el=document.createElement('div');el.className='t-file';el.style.paddingLeft=pad;el.title=f.path;
    el.innerHTML=`<span>${iconFrom(f.path)}</span><span class="t-nm">${f.name}</span>`;
    el.onclick=()=>openFile(f.path);
    container.appendChild(el);
  });
}

function updateFileTreeMod(){
  document.querySelectorAll('.t-file').forEach(el=>{
    const tab=tabs.find(t=>t.path===el.title);
    el.classList.toggle('mod',tab&&tab.mod);
  });
}

async function openFile(path){
  let tab=tabs.find(t=>t.path===path);
  if(!tab){
    const[owner,repo]=curRepo.split('/');
    const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${curBranch}`,{headers:ghH()});
    if(!r.ok){notify('Failed to load file','e');return;}
    const d=await r.json();
    let content='';
    try{content=decodeURIComponent(escape(atob(d.content.replace(/\n/g,''))));}
    catch{content='[Binary file â€” cannot display]';}
    tab={path,content,sha:d.sha,mod:false,lang:langFrom(path)};
    tabs.push(tab);
    syncVFS();
  }
  setActiveTab(tab);
}

function setActiveTab(tab){
  activeTab=tab;
  document.getElementById('welcome').style.display='none';
  document.getElementById('me').style.display='block';
  if(editor){
    const m=monaco.editor.createModel(tab.content,tab.lang);
    editor.setModel(m);
  }
  document.getElementById('s-file').textContent=tab.path.split('/').pop();
  const lc=LANG_COLORS[tab.lang]||'var(--text3)';
  document.getElementById('s-lang').innerHTML=`<span class="lang-pill" style="background:${lc}22;color:${lc}">${tab.lang}</span>`;
  syncRunBtn();syncCommitBtn();renderTabs();
  document.querySelectorAll('.t-file').forEach(el=>el.classList.toggle('active',el.title===tab.path));
}

function syncRunBtn(){
  const canRun=activeTab&&RUNNABLE.has(activeTab.lang)&&(activeTab.lang!=='python'||pyReady);
  document.getElementById('run-btn').disabled=!canRun;
}
function syncCommitBtn(){
  const hasChanges=tabs.some(t=>t.mod);
  document.getElementById('commit-btn').style.display=hasChanges?'flex':'none';
}

function closeTab(path,e){
  e?.stopPropagation();
  const idx=tabs.findIndex(t=>t.path===path);if(idx<0)return;
  tabs.splice(idx,1);
  if(activeTab?.path===path){
    activeTab=tabs[Math.min(idx,tabs.length-1)]||null;
    if(activeTab)setActiveTab(activeTab);
    else{
      document.getElementById('welcome').style.display='flex';
      document.getElementById('me').style.display='none';
      document.getElementById('s-file').textContent='No file';
      document.getElementById('s-lang').textContent='';
      document.getElementById('commit-btn').style.display='none';
      document.getElementById('run-btn').disabled=true;
    }
  }
  renderTabs();
  updateFileTreeMod();
  syncCommitBtn();
  syncVFS();
}

function renderTabs(){
  const bar=document.getElementById('tabbar');
  document.getElementById('no-tabs').style.display=tabs.length?'none':'flex';
  bar.querySelectorAll('.tab').forEach(e=>e.remove());
  tabs.forEach(t=>{
    const d=document.createElement('div');
    d.className=`tab${t===activeTab?' active':''}${t.mod?' mod':''}`;
    d.innerHTML=`<span>${t.path.split('/').pop()}</span><button class="tab-x" onclick="closeTab('${t.path}',event)">Ã—</button>`;
    d.onclick=()=>setActiveTab(t);
    bar.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCommitModal(){
  const modFiles=tabs.filter(t=>t.mod);
  if(!modFiles.length){notify('No files modified','w');return;}
  
  const list=document.getElementById('commit-files');
  list.innerHTML=modFiles.map(t=>`
    <div class="cf-item mod">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span>${t.path}</span>
    </div>
  `).join('');
  
  document.getElementById('commit-msg').value=modFiles.length===1
    ?`Update ${modFiles[0].path}`
    :`Update ${modFiles.length} files`;
  document.getElementById('modal-commit').classList.add('on');
}

async function doCommitAll(){
  const modFiles=tabs.filter(t=>t.mod);
  if(!modFiles.length){notify('No files to commit','w');return;}
  if(!curRepo){notify('No repository selected','e');return;}
  
  const msg=document.getElementById('commit-msg').value.trim()||`Update ${modFiles.length} files`;
  const[owner,repo]=curRepo.split('/');
  
  closeModal('commit');
  document.getElementById('commit-ok-btn').disabled=true;
  notify(`Committing ${modFiles.length} file(s)â€¦`,'i');
  
  let success=0,failed=0;
  
  for(const tab of modFiles){
    try{
      if(tab===activeTab&&editor){
        tab.content=editor.getValue();
      }
      
      const encoded=btoa(unescape(encodeURIComponent(tab.content)));
      const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${tab.path}`,{
        method:'PUT',
        headers:{...ghH(),'Content-Type':'application/json'},
        body:JSON.stringify({message:msg,content:encoded,sha:tab.sha,branch:curBranch})
      });
      
      if(r.ok){
        const d=await r.json();
        tab.sha=d.content.sha;
        tab.mod=false;
        success++;
      }else{
        const err=await r.json();
        console.error(`Failed ${tab.path}:`,err.message);
        failed++;
      }
    }catch(e){
      console.error(`Error ${tab.path}:`,e);
      failed++;
    }
  }
  
  document.getElementById('commit-ok-btn').disabled=false;
  renderTabs();
  updateFileTreeMod();
  syncCommitBtn();
  syncVFS();
  
  if(failed===0){
    notify(`âœ“ Committed ${success} file(s)`,'s');
  }else{
    notify(`Committed ${success}, failed ${failed}`,'w');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI â€” with FULL REPO CONTEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRepoContext(){
  // Build comprehensive repository context for AI
  let context=`Repository: ${curRepo}\nBranch: ${curBranch}\n\n`;
  
  // File structure
  context+=`FILE STRUCTURE:\n`;
  const tree=repoTree.filter(i=>i.type==='blob').map(i=>i.path).sort();
  context+=tree.map(p=>`  ${p}`).join('\n');
  context+=`\n\nTOTAL FILES: ${tree.length}\n\n`;
  
  // Currently open files with full content
  if(tabs.length){
    context+=`OPEN FILES (${tabs.length}):\n\n`;
    tabs.forEach(t=>{
      const content=t===activeTab&&editor?editor.getValue():t.content;
      context+=`â”â”â” ${t.path} ${t.mod?'(MODIFIED)':''} â”â”â”\n`;
      context+=`${content}\n\n`;
    });
  }
  
  // Active file highlight
  if(activeTab){
    context+=`CURRENTLY ACTIVE FILE: ${activeTab.path}\n`;
  }
  
  return context;
}

function aiKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAI();}}
async function sendAI(){
  const inp=document.getElementById('ai-inp');
  const txt=inp.value.trim();if(!txt)return;

  const provider=userSettings.provider||'claude';
  const apiKey=(userSettings.keys||{})[provider];
  if(!apiKey){
    notify('Add your '+provider+' API key in Settings first.','w');
    openSettings();return;
  }

  inp.value='';
  appendAM('user',txt);
  aiHistory.push({role:'user',content:txt});
  document.getElementById('ai-send').disabled=true;

  // Build comprehensive repo context
  const repoContext=curRepo?buildRepoContext():'No repository currently open.';
  const system=`You are an expert coding assistant embedded in FlashCode IDE.

${repoContext}

Be concise and helpful. Use markdown code blocks for code. When suggesting changes, reference specific files and line numbers when relevant.`;

  try{
    let reply='';
    if(provider==='claude'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01'},
        body:JSON.stringify({
          model:userSettings.model||'claude-sonnet-4-20250514',
          max_tokens:4096,
          system,
          messages:aiHistory
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.content?.[0]?.text||'No response.';
    }else if(provider==='openai'){
      const msgs=[{role:'system',content:system},...aiHistory];
      const r=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body:JSON.stringify({
          model:userSettings.model||'gpt-4o',
          messages:msgs
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.choices?.[0]?.message?.content||'No response.';
    }else if(provider==='gemini'){
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${userSettings.model||'gemini-2.0-flash-exp'}:generateContent?key=${apiKey}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          contents:aiHistory.map(m=>({role:m.role==='assistant'?'model':'user',parts:[{text:m.content}]})),
          systemInstruction:{parts:[{text:system}]}
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.candidates?.[0]?.content?.parts?.[0]?.text||'No response.';
    }else if(provider==='grok'){
      const msgs=[{role:'system',content:system},...aiHistory];
      const r=await fetch('https://api.x.ai/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body:JSON.stringify({
          model:userSettings.model||'grok-2-latest',
          messages:msgs
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.choices?.[0]?.message?.content||'No response.';
    }else if(provider==='groq'){
      const msgs=[{role:'system',content:system},...aiHistory];
      const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body:JSON.stringify({
          model:userSettings.model||'llama-3.3-70b-versatile',
          messages:msgs
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.choices?.[0]?.message?.content||'No response.';
    }else if(provider==='openrouter'){
      const msgs=[{role:'system',content:system},...aiHistory];
      const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey,'HTTP-Referer':window.location.href,'X-Title':'FlashCode IDE'},
        body:JSON.stringify({
          model:userSettings.model||'anthropic/claude-sonnet-4',
          messages:msgs
        })
      });
      const data=await r.json();
      if(data.error){throw new Error(data.error.message||'API error');}
      reply=data.choices?.[0]?.message?.content||'No response.';
    }else{
      throw new Error('Unsupported provider: '+provider);
    }
    
    aiHistory.push({role:'assistant',content:reply});
    appendAM('assistant',reply);
  }catch(e){
    appendAM('assistant','âŒ Error: '+e.message);
    console.error('AI error:',e);
  }
  document.getElementById('ai-send').disabled=false;
}

function appendAM(role,text){
  const msgs=document.getElementById('ai-msgs');
  const d=document.createElement('div');d.className=`am ${role}`;
  d.innerHTML=`<div class="am-av">${role==='user'?'U':'AI'}</div>
    <div class="am-b"><div class="am-r">${role==='user'?'You':'Assistant'}</div>
    <div class="am-t">${fmtAI(text)}</div></div>`;
  msgs.appendChild(d);msgs.scrollTop=9999;
}
function fmtAI(t){
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```(\w*)\n?([\s\S]*?)```/g,(_,l,c)=>`<pre style="background:var(--bg3);padding:8px 10px;border-radius:6px;overflow-x:auto;margin:4px 0;font-size:11px;font-family:var(--mono)">${c.trim()}</pre>`)
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n/g,'<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPanel(name){
  document.querySelectorAll('.p-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.p-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('pt-'+name).classList.add('active');
  document.getElementById('pc-'+name).classList.add('active');
  if(!panelVisible)togglePanel();
}
function togglePanel(){
  panelVisible=!panelVisible;
  document.getElementById('bp').classList.toggle('hidden',!panelVisible);
}
function setAct(btn,name){
  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(name==='preview'){
    const hasIndex=repoTree.some(f=>f.path==='index.html'||f.path.split('/').pop()==='index.html');
    if(hasIndex){openRepoPreview();}
    else if(activeTab&&activeTab.lang==='html'){openInlinePreview(editor?editor.getValue():activeTab.content,activeTab.path);}
    else{notify('No HTML file loaded for preview.','w');document.querySelector('.act-btn[title="Explorer"]').classList.add('on');btn.classList.remove('on');}
  }else if(name==='ai'){
    document.getElementById('preview-wrap').classList.remove('on');
    switchPanel('ai');
  }else{
    document.getElementById('preview-wrap').classList.remove('on');
    if(activeTab){document.getElementById('me').style.display='block';document.getElementById('welcome').style.display='none';}
    else{document.getElementById('welcome').style.display='flex';document.getElementById('me').style.display='none';}
  }
}

function notify(msg,type='i'){
  const el=document.createElement('div');el.className=`ni ${type}`;el.textContent=msg;
  document.getElementById('notif').appendChild(el);setTimeout(()=>el.remove(),4000);
}

document.addEventListener('click',e=>{
  if(!e.target.closest('#umenu')&&!e.target.closest('#u-av'))document.getElementById('umenu').classList.remove('on');
  if(!e.target.closest('#modal-repo')&&!e.target.closest('.repo-sel'))document.getElementById('modal-repo').classList.remove('on');
});

// â”€â”€ Resize handle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rz=false,rzY=0,rzH=0;
document.getElementById('rh').addEventListener('mousedown',e=>{rz=true;rzY=e.clientY;rzH=document.getElementById('bp').offsetHeight;document.body.style.cssText='cursor:row-resize;user-select:none';});
document.addEventListener('mousemove',e=>{if(!rz)return;const h=Math.max(80,Math.min(600,rzH+(rzY-e.clientY)));document.getElementById('bp').style.height=h+'px';});
document.addEventListener('mouseup',()=>{rz=false;document.body.style.cssText='';});

init();
</script>
</body>
</html>
