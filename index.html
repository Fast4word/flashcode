<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FlashCode IDE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg0:#0d0d0d;--bg1:#141414;--bg2:#1a1a1a;--bg3:#222;--bg4:#2a2a2a;
  --border:#2e2e2e;--text:#d4d4d4;--text2:#888;--text3:#555;
  --accent:#3b82f6;--accent2:#1d4ed8;--green:#22c55e;--red:#ef4444;
  --yellow:#eab308;--purple:#a855f7;
  --mono:'Fira Code','Cascadia Code',Consolas,monospace;
  --ui:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  --sw:44px;--sbw:240px;--ph:220px;--tbh:40px;--tbbh:36px;--sbh:24px;
}
html,body{height:100%;overflow:hidden;background:var(--bg0);color:var(--text);font-family:var(--ui);font-size:13px}
#auth{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:24px}
.auth-logo{display:flex;align-items:center;gap:12px}
.auth-logo svg{color:var(--accent)}
.auth-logo h1{font-size:28px;font-weight:700;letter-spacing:-.5px;color:#fff}
.auth-logo span{color:var(--accent)}
.auth-tag{color:var(--text2);font-size:14px}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:32px;display:flex;flex-direction:column;gap:16px;width:340px}
.auth-card h2{font-size:16px;font-weight:600;color:#fff}
.auth-card p{color:var(--text2);font-size:13px;line-height:1.5}
.btn-gh{display:flex;align-items:center;justify-content:center;gap:10px;background:#fff;color:#0d0d0d;border:none;border-radius:8px;padding:11px 16px;font-size:14px;font-weight:600;cursor:pointer;transition:background.15s}
.btn-gh:hover{background:#e5e5e5}
#ide{display:none;flex-direction:column;height:100vh}
#ide.on{display:flex}
#tb{height:var(--tbh);background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0;user-select:none;position:relative}
.tb-logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;flex-shrink:0}
.tb-logo span{color:var(--accent)}
.tb-sep{width:1px;height:18px;background:var(--border);flex-shrink:0}
.repo-sel{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text);min-width:160px;max-width:220px}
.repo-sel:hover{border-color:var(--accent)}
#repo-lbl{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.br-badge{background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:11px;color:var(--accent);font-family:var(--mono);display:none;flex-shrink:0}
.tb-actions{margin-left:auto;display:flex;gap:6px;align-items:center;flex-shrink:0}
.btn-icon{background:none;border:none;color:var(--text2);cursor:pointer;padding:5px;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:background.15s,color.15s;flex-shrink:0}
.btn-icon:hover{background:var(--bg4);color:var(--text)}
.btn-run{display:flex;align-items:center;gap:6px;background:var(--green);color:#000;border:none;border-radius:6px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity.15s;flex-shrink:0}
.btn-run:hover{opacity:.85}
.btn-run:disabled{opacity:.4;cursor:not-allowed}
.btn-commit{display:none;align-items:center;gap:6px;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity.15s;flex-shrink:0}
.btn-commit:hover{opacity:.85}
.avatar{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);cursor:pointer;object-fit:cover;flex-shrink:0}
.umenu{position:absolute;top:calc(var(--tbh) + 4px);right:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;min-width:180px;z-index:500;display:none}
.umenu.on{display:block}
.umenu-item{padding:8px 12px;border-radius:5px;cursor:pointer;color:var(--text2);font-size:12px;transition:background.1s;display:flex;align-items:center;gap:8px}
.umenu-item:hover{background:var(--bg4);color:var(--text)}
.umenu-item.danger:hover{background:#3f1212;color:var(--red)}
.umenu-sep{height:1px;background:var(--border);margin:4px 0}
#main{display:flex;flex:1;overflow:hidden}
#actbar{width:var(--sw);background:var(--bg0);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:4px;flex-shrink:0}
.act-btn{width:34px;height:34px;border-radius:7px;background:none;border:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background.15s,color.15s;position:relative}
.act-btn:hover,.act-btn.on{background:var(--bg3);color:var(--text)}
.act-btn.on{color:var(--accent)}
.act-btn[data-dot]::after{content:'';position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;background:var(--yellow)}
#sb{width:var(--sbw);background:var(--bg1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.sb-hdr{height:36px;display:flex;align-items:center;padding:0 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);border-bottom:1px solid var(--border);flex-shrink:0;justify-content:space-between}
#ftree{flex:1;overflow-y:auto;padding:4px 0}
#ftree::-webkit-scrollbar{width:4px}
#ftree::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.t-dir{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--text2);transition:background.1s,color.1s;white-space:nowrap;overflow:hidden;user-select:none;padding:3px 8px 3px 0}
.t-dir:hover{background:var(--bg3);color:var(--text)}
.t-dir svg.chev{flex-shrink:0;transition:transform.15s}
.t-dir.open svg.chev{transform:rotate(90deg)}
.t-file{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--text2);transition:background.1s,color.1s;white-space:nowrap;overflow:hidden;padding:3px 8px 3px 0}
.t-file:hover{background:var(--bg3);color:var(--text)}
.t-file.active{background:var(--bg4);color:#fff}
.t-ch{display:none}
.t-ch.open{display:block}
.t-nm{overflow:hidden;text-overflow:ellipsis}
.sb-empty{padding:16px 12px;color:var(--text3);font-size:12px;line-height:1.6}
#ea{flex:1;display:flex;flex-direction:column;overflow:hidden}
#tabbar{height:var(--tbbh);background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:flex-end;overflow-x:auto;flex-shrink:0}
#tabbar::-webkit-scrollbar{height:0}
.tab{display:flex;align-items:center;gap:6px;padding:0 14px;height:100%;border-right:1px solid var(--border);font-size:12px;cursor:pointer;color:var(--text2);white-space:nowrap;background:var(--bg1);transition:background.1s,color.1s;flex-shrink:0;position:relative}
.tab:hover{background:var(--bg2);color:var(--text)}
.tab.active{background:var(--bg2);color:#fff}
.tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent)}
.tab.mod::before{content:'‚óè';color:var(--yellow);margin-right:-4px;font-size:10px}
.tab-x{width:16px;height:16px;border-radius:3px;border:none;background:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;line-height:1;transition:background.1s,color.1s}
.tab-x:hover{background:var(--bg4);color:var(--text)}
#no-tabs{display:flex;align-items:center;padding:0 16px;color:var(--text3);font-size:12px}
#epc{flex:1;display:flex;flex-direction:column;overflow:hidden}
#ec{flex:1;overflow:hidden;position:relative;display:flex;flex-direction:column}
#me{flex:1}
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;color:var(--text3)}
#welcome h2{font-size:20px;color:var(--text2)}
#welcome p{font-size:13px;line-height:1.6;text-align:center;max-width:360px}
#welcome kbd{background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-family:var(--mono);font-size:11px;color:var(--text2)}
#preview-wrap{position:absolute;inset:0;background:#fff;display:none;flex-direction:column;z-index:10}
#preview-wrap.on{display:flex}
#preview-toolbar{background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:0 12px;height:34px;flex-shrink:0}
#preview-url{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:3px 8px;color:var(--text);font-size:12px;font-family:var(--mono);outline:none}
#preview-frame{flex:1;border:none;background:#fff}
#bp{background:var(--bg1);border-top:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;height:var(--ph)}
#bp.hidden{display:none}
.p-tabs{display:flex;border-bottom:1px solid var(--border);height:32px;flex-shrink:0;align-items:center}
.p-tab{display:flex;align-items:center;gap:6px;padding:0 14px;font-size:12px;color:var(--text3);cursor:pointer;border-right:1px solid var(--border);height:100%;transition:background.1s,color.1s}
.p-tab:hover{background:var(--bg2);color:var(--text2)}
.p-tab.active{color:var(--text);background:var(--bg2)}
.p-acts{margin-left:auto;display:flex;align-items:center;padding:0 8px;gap:4px}
.p-content{flex:1;overflow:hidden;display:none;flex-direction:column}
.p-content.active{display:flex}
#term{flex:1;overflow-y:auto;padding:10px 14px;font-family:var(--mono);font-size:12px;line-height:1.6;background:var(--bg0)}
#term::-webkit-scrollbar{width:4px}
#term::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.tl{white-space:pre-wrap;word-break:break-all}
.ti{color:var(--text2)}.ts{color:var(--green)}.te{color:var(--red)}.tw{color:var(--yellow)}.tp{color:var(--accent)}.to{color:var(--text)}
#tinr{display:flex;align-items:center;gap:8px;padding:6px 14px;border-top:1px solid var(--border);background:var(--bg0)}
#tprompt{color:var(--accent);font-family:var(--mono);font-size:12px}
#tinput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:12px}
#ai-wrap{flex:1;display:flex;flex-direction:column;background:var(--bg0)}
#ai-msgs{flex:1;overflow-y:auto;padding:10px 14px;display:flex;flex-direction:column;gap:10px}
#ai-msgs::-webkit-scrollbar{width:4px}
#ai-msgs::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.am{display:flex;gap:8px}
.am-av{width:24px;height:24px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
.am.user.am-av{background:var(--accent);color:#fff}
.am.assistant.am-av{background:var(--purple);color:#fff}
.am-b{flex:1}
.am-r{font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text3);margin-bottom:2px}
.am-t{font-size:12px;line-height:1.6;color:var(--text);white-space:pre-wrap;word-break:break-word}
.am-t code{font-family:var(--mono);background:var(--bg3);padding:1px 4px;border-radius:3px;font-size:11px}
#ai-inp-row{display:flex;gap:8px;padding:8px 14px;border-top:1px solid var(--border);background:var(--bg1)}
#ai-inp{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--ui);resize:none;height:34px;line-height:1.4}
#ai-inp:focus{border-color:var(--accent)}
.btn-send{background:var(--accent);border:none;border-radius:6px;color:#fff;width:34px;height:34px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity.15s}
.btn-send:hover{opacity:.85}
.btn-send:disabled{opacity:.4;cursor:not-allowed}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center}
.modal.on{display:flex}
.mbox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:500px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.mbox.wide{width:580px}
.mhdr{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.mhdr h3{font-size:15px;font-weight:600}
.mbody{padding:16px 20px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
.mbody p{color:var(--text2);font-size:12px}
.mftr{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0}
.btn-cancel{background:var(--bg4);border:1px solid var(--border);color:var(--text2);border-radius:6px;padding:7px 14px;cursor:pointer;font-size:13px}
.btn-cancel:hover{color:var(--text)}
.btn-ok{background:var(--accent);border:none;color:#fff;border-radius:6px;padding:7px 14px;cursor:pointer;font-size:13px;font-weight:600}
.btn-ok:hover{opacity:.85}
#repo-search{margin:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;width:calc(100% - 32px)}
#repo-search:focus{border-color:var(--accent)}
#repo-list{overflow-y:auto;padding:4px 8px 8px}
#repo-list::-webkit-scrollbar{width:4px}
#repo-list::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.ri{display:flex;flex-direction:column;padding:10px 12px;border-radius:7px;cursor:pointer;transition:background.1s}
.ri:hover{background:var(--bg3)}
.ri-n{font-size:13px;color:#fff;font-weight:500}
.ri-m{font-size:11px;color:var(--text3);margin-top:2px}
.field{display:flex;flex-direction:column;gap:5px}
.field label{font-size:12px;color:var(--text2);font-weight:500}
.field input,.field select,.field textarea{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;color:var(--text);font-size:13px;outline:none;font-family:var(--ui)}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent)}
.field select option{background:var(--bg3)}
.field textarea{resize:vertical;min-height:70px}
.field.hint{font-size:11px;color:var(--text3)}
.provider-section{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px;display:flex;flex-direction:column;gap:10px}
.provider-section h4{font-size:12px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
.provider-badge{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
.key-row{display:flex;gap:8px;align-items:center}
.key-row input{flex:1;background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--mono)}
.key-row input:focus{border-color:var(--accent)}
.key-row.btn-icon{background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text2)}
#statusbar{height:var(--sbh);background:var(--accent2);display:flex;align-items:center;padding:0 12px;gap:16px;font-size:11px;color:rgba(255,255,255,.8);flex-shrink:0;user-select:none}
.si{display:flex;align-items:center;gap:5px}
.si.r{margin-left:auto}
.lang-pill{font-size:10px;padding:1px 6px;border-radius:10px;font-family:var(--mono);font-weight:600}
#rh{height:4px;background:transparent;cursor:row-resize;flex-shrink:0;border-top:1px solid var(--border)}
#rh:hover{background:var(--accent)}
#notif{position:fixed;bottom:32px;right:16px;z-index:600;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.ni{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:sIn.2s ease;max-width:300px}
.ni.s{border-color:var(--green)}.ni.e{border-color:var(--red)}.ni.w{border-color:var(--yellow)}
@keyframes sIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{animation:spin.8s linear infinite;display:inline-block}
</style>
</head>
<body>

<!-- AUTH, IDE HTML, MODALS -->
<!-- All your existing HTML from <body> to <div id="notif"></div> goes here. It is unchanged. -->
<div id="auth">...</div>
<div id="ide">...</div>
<div id="statusbar">...</div>
<div id="modal-repo">...</div>
<div id="modal-commit">...</div>
<div id="modal-settings">...</div>
<div id="notif"></div>
<!-- End of unchanged HTML -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

<!-- SERVICE WORKER SCRIPT -->
<script id="sw-script" type="text/sw-template">
  let VFS = {};
  const PREVIEW_SCOPE = '/__preview__/';

  self.addEventListener('message', event => {
    if (event.data.type === 'INIT_VFS') {
      VFS = event.data.payload;
      // console.log('SW: Virtual File System initialized/updated.');
    }
  });

  self.addEventListener('fetch', event => {
    const url = new URL(event.request.url);
    if (!url.pathname.startsWith(PREVIEW_SCOPE)) {
      return; // Not a preview request, fetch normally
    }

    const path = url.pathname.substring(PREVIEW_SCOPE.length).split('?')[0] || 'index.html';
    // console.log(`SW: Intercepted request for: ${path}`);

    if (VFS[path]) {
      const { content, type } = VFS[path];
      const headers = { 'Content-Type': type || 'application/octet-stream' };
      const response = new Response(content, { headers });
      event.respondWith(response);
    } else {
      // console.log(`SW: File not found in VFS: ${path}`);
      event.respondWith(new Response('File not found', { status: 404 }));
    }
  });
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL = 'https://uvslkqxtkortoiacmknw.supabase.co';
const SB_KEY = 'sb_publishable_7kz7TnR6P4cwRVlr7C_0bA_iqtTVwiF';
const AI_URL = `${SB_URL}/functions/v1/ai-proxy`;
const PREVIEW_SCOPE = '/__preview__/';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let session=null, ghToken=null, curRepo=null, curBranch='main';
let tabs=[], activeTab=null, editor=null;
let pyodide=null, pyReady=false;
let allRepos=[], aiHistory=[];
let panelVisible=true;
let userSettings={}; // { provider, model, keys:{claude,openai,...} }
let repoTree=[]; // flat tree items

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LANG / ICON / MIME MAPS (Added MIME)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LANG_MAP={py:'python',js:'javascript',ts:'typescript',jsx:'javascript',tsx:'typescript',json:'json',md:'markdown',css:'css',html:'html',sh:'shell',yml:'yaml',yaml:'yaml',rs:'rust',go:'go',java:'java',c:'c',cpp:'cpp',cs:'csharp',rb:'ruby',php:'php',vue:'html',svelte:'html',kt:'kotlin',swift:'swift',sql:'sql',graphql:'graphql',toml:'ini',xml:'xml',txt:'plaintext'};
const ICON_MAP={py:'üêç',js:'‚ö°',ts:'üî∑',jsx:'‚öõ',tsx:'‚öõ',json:'{}',md:'üìù',css:'üé®',html:'üåê',yml:'‚öô',yaml:'‚öô',sh:'üíª',rs:'ü¶Ä',go:'üêπ',java:'‚òï',rb:'üíé',php:'üêò',vue:'üíö',svelte:'üß°',sql:'üóÑ',xml:'üìã',txt:'üìÑ',toml:'‚öô',env:'üîê',lock:'üîí'};
const MIME_MAP = {
    html: 'text/html', htm: 'text/html', css: 'text/css', js: 'application/javascript', mjs: 'application/javascript',
    json: 'application/json', png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg', gif: 'image/gif',
    svg: 'image/svg+xml', ico: 'image/x-icon', txt: 'text/plain', md: 'text/markdown',
    woff: 'font/woff', woff2: 'font/woff2', ttf: 'font/ttf', eot: 'application/vnd.ms-fontobject',
};
const LANG_COLORS={python:'#3b82f6',javascript:'#eab308',typescript:'#3b82f6',html:'#f97316',css:'#a855f7',rust:'#f97316',go:'#22c55e',ruby:'#ef4444',java:'#f97316'};
const RUNNABLE=new Set(['python','javascript','typescript','html']);

function langFrom(p=''){const e=p.split('.').pop()?.toLowerCase();return LANG_MAP[e]||'plaintext';}
function iconFrom(p=''){const e=p.split('.').pop()?.toLowerCase();return ICON_MAP[e]||'üìÑ';}
function mimeFrom(p=''){const e=p.split('.').pop()?.toLowerCase();return MIME_MAP[e]||'application/octet-stream';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVICE WORKER SETUP (NEW)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initServiceWorker() {
  const swScript = document.getElementById('sw-script').textContent;
  const swBlob = new Blob([swScript], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(swBlob);

  if ('serviceWorker' in navigator) {
    try {
      await navigator.serviceWorker.register(swUrl, { scope: PREVIEW_SCOPE });
      console.log('Service Worker registered successfully.');
    } catch (error) {
      console.error('Service Worker registration failed:', error);
      notify('Dynamic preview unavailable: Service Worker failed.', 'e');
    }
  }
}

async function updateVFS() {
  if (!navigator.serviceWorker.controller) return;

  const vfs = {};
  const allFiles = [...repoTree]; // Use the full tree

  // Add currently open (and possibly modified) files from tabs
  const openFiles = new Set(tabs.map(t => t.path));
  tabs.forEach(tab => {
      vfs[tab.path] = {
          content: tab.content,
          type: mimeFrom(tab.path)
      };
  });

  // Fetch content for all other files in the repo (or just add them as placeholders)
  for (const file of allFiles) {
      if (!openFiles.has(file.path) && file.type === 'blob') {
          // To avoid fetching all files at once, we can fetch them on demand
          // Or for simplicity here, we add them if they are already in tabs,
          // and let the SW handle fetching later if needed.
          // A more advanced implementation would fetch them here.
          // For now, let's just make sure the existing tabs are in the VFS.
          if (!vfs[file.path]) {
            vfs[file.path] = { content: null, type: mimeFrom(file.path), sha: file.sha }; // Mark for lazy load
          }
      }
  }

  // Get content for all files in repoTree to make preview work fully
  const [owner, repo] = curRepo.split('/');
  const promises = repoTree
     .filter(f => f.type === 'blob' &&!vfs[f.path]?.content) // only fetch if not already in tabs
     .map(async file => {
          try {
              const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/blobs/${file.sha}`, { headers: ghH() });
              if (!r.ok) throw new Error('Failed to fetch blob');
              const d = await r.json();
              const isBase64 = d.encoding === 'base64';
              const content = isBase64? b64toBlob(d.content, mimeFrom(file.path)) : d.content;
              vfs[file.path] = { content, type: mimeFrom(file.path) };
          } catch(e) {
              console.error(`Failed to fetch content for ${file.path}`, e);
          }
      });
  
  await Promise.all(promises);

  navigator.serviceWorker.controller.postMessage({
    type: 'INIT_VFS',
    payload: vfs
  });
}

function b64toBlob(b64Data, contentType='', sliceSize=512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    return new Blob(byteArrays, {type: contentType});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  await initServiceWorker(); // Initialize SW on startup
  const hash=window.location.hash;
  if(hash){
    const p=new URLSearchParams(hash.slice(1));
    const at=p.get('access_token'),pt=p.get('provider_token');
    if(at){session={access_token:at};ghToken=pt;history.replaceState(null,'',location.pathname);await loadUser();return;}
  }
  const stored=sessionStorage.getItem('fc_s');
  if(stored){try{const s=JSON.parse(stored);session=s.s;ghToken=s.g;await loadUser();return;}catch{}}
  showAuth();
}
//... rest of auth functions are unchanged...
async function loadUser(){
  const r=await fetch(`${SB_URL}/auth/v1/user`,{headers:{apikey:SB_KEY,Authorization:`Bearer ${session.access_token}`}}).catch(()=>null);
  if(!r||!r.ok){showAuth();return;}
  const u=await r.json();
  sessionStorage.setItem('fc_s',JSON.stringify({s:session,g:ghToken}));
  document.getElementById('u-av').src=u.user_metadata?.avatar_url||'';
  document.getElementById('u-name').textContent=u.user_metadata?.full_name||u.email;
  showIDE();
  await loadSettings();
  initMonaco();
  loadPyodide();
}
function showAuth(){document.getElementById('auth').style.display='flex';document.getElementById('ide').classList.remove('on');}
function showIDE(){document.getElementById('auth').style.display='none';document.getElementById('ide').classList.add('on');}
function signIn(){const r=encodeURIComponent(location.href.split('#')[0]);location.href=`${SB_URL}/auth/v1/authorize?provider=github&redirect_to=${r}&scopes=repo`;}
async function signOut(){
  await fetch(`${SB_URL}/auth/v1/logout`,{method:'POST',headers:{apikey:SB_KEY,Authorization:`Bearer ${session.access_token}`}}).catch(()=>{});
  sessionStorage.removeItem('fc_s');session=null;ghToken=null;
  document.getElementById('umenu').classList.remove('on');
  showAuth();
}
function toggleUMenu(){document.getElementById('umenu').classList.toggle('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RUN CODE ‚Äî language-aware (MODIFIED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runCode(){
  if(!activeTab)return;
  const code=editor?editor.getValue():activeTab.content;
  const lang=activeTab.lang;

  if(lang==='html'){
    const hasIndex=repoTree.some(f=>f.path.split('/').pop()==='index.html');
    if(activeTab.path.endsWith('index.html')||hasIndex){
      openRepoPreview(); // Use the new dynamic preview
    }else{
      openInlinePreview(code,activeTab.path); // Keep old method for single, non-index files
    }
    return;
  }
  //... rest of runCode is unchanged...
  if(lang==='python'){
    if(!panelVisible)togglePanel();
    switchPanel('terminal');
    tLog(`\n‚ñ∂ Running ${activeTab.path}‚Ä¶`,'i');
    await execPy(code);return;
  }
  if(lang==='javascript'||lang==='typescript'){
    if(!panelVisible)togglePanel();
    switchPanel('terminal');
    tLog(`\n‚ñ∂ Running ${activeTab.path} in sandbox‚Ä¶`,'i');
    try{
      const wrapped=`
const _log=(...a)=>postMessage({type:'log',data:a.join(' ')});
const _err=(...a)=>postMessage({type:'err',data:a.join(' ')});
const console={log:_log,error:_err,warn:_log,info:_log,debug:_log};
try{${code}}catch(e){_err(e.message)}`;
      const blob=new Blob([wrapped],{type:'text/javascript'});
      const url=URL.createObjectURL(blob);
      const w=new Worker(url);
      w.onmessage=e=>{tLog(e.data.data,e.data.type==='err'?'e':'o');};
      w.onerror=e=>tLog(e.message,'e');
      setTimeout(()=>{w.terminate();URL.revokeObjectURL(url);},15000);
    }catch(e){tLog(e.message,'e');}
    return;
  }
  tLog(`Cannot run ${lang} files in the browser.`,'w');
  if(!panelVisible)togglePanel();
  switchPanel('terminal');
}

// ‚îÄ‚îÄ Preview helpers (MODIFIED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openInlinePreview(html,title){
  document.getElementById('preview-title').textContent=title||'Preview';
  document.getElementById('preview-frame').srcdoc=html;
  document.getElementById('preview-wrap').classList.add('on');
}

async function openRepoPreview(){
  if (!curRepo) { notify('Open a repository first.', 'w'); return; }
  const indexFile = repoTree.find(f => f.path.split('/').pop() === 'index.html');
  if (!indexFile) { notify('Repository has no index.html file to preview.', 'w'); return; }
  
  notify('Building virtual file system for preview...', 'i');
  await updateVFS(); // Update the Service Worker's file system

  const previewFrame = document.getElementById('preview-frame');
  const previewUrl = PREVIEW_SCOPE + 'index.html';

  // Setting src to the service worker's scope triggers it
  previewFrame.src = previewUrl; 
  previewFrame.removeAttribute('srcdoc'); // Ensure srcdoc is not used

  document.getElementById('preview-title').textContent = `${curRepo} - Preview`;
  document.getElementById('preview-wrap').classList.add('on');

  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('on'));
  document.querySelector('.act-btn[title="Preview"]').classList.add('on');
}

function closePreview(){
  document.getElementById('preview-wrap').classList.remove('on');
  // Also clear the iframe src to stop any running scripts
  document.getElementById('preview-frame').src = 'about:blank';
  document.querySelectorAll('.act-btn').forEach(b=>b.classList.remove('on'));
  document.querySelector('.act-btn[title="Explorer"]').classList.add('on');
}

function reloadPreview(){
  const f=document.getElementById('preview-frame');
  f.contentWindow.location.reload();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GITHUB (MODIFIED selectRepo to trigger VFS update)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//... ghH, openRepoModal, closeModal, renderRepoList, filterRepos are unchanged...
async function selectRepo(full,branch){
  closeModal('repo');curRepo=full;curBranch=branch||'main';
  document.getElementById('repo-lbl').textContent=full;
  document.getElementById('s-repo').textContent=full;
  const bb=document.getElementById('br-badge');bb.style.display='flex';bb.textContent=curBranch;
  await refreshTree();
  // After getting the new tree, update the virtual file system
  await updateVFS();
}
//... rest of GitHub functions are unchanged...

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE HANDLING (MODIFIED openFile & doCommit to trigger VFS update)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//... buildTree, renderNode are unchanged...

async function openFile(path){
  let tab=tabs.find(t=>t.path===path);
  if(!tab){
    const[owner,repo]=curRepo.split('/');
    const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${curBranch}`,{headers:ghH()});
    if(!r.ok){notify('Failed to load file','e');return;}
    const d=await r.json();
    let content='';
    if (d.content) {
      try{content=decodeURIComponent(escape(atob(d.content.replace(/\n/g,''))));}
      catch{content='[Binary file ‚Äî cannot display]';}
    } else {
        content = '[File is too large or binary]';
    }
    tab={path,content,sha:d.sha,mod:false,lang:langFrom(path)};
    tabs.push(tab);
    await updateVFS(); // Update VFS when a new file is loaded
  }
  setActiveTab(tab);
}

//... setActiveTab, syncRunBtn are unchanged...
function syncCommitBtn(){
  // This function is fine, but we need to update VFS on change
  const isModified = activeTab && activeTab.mod;
  document.getElementById('commit-btn').style.display = isModified? 'flex' : 'none';
  if (isModified) {
    updateVFS(); // Update VFS whenever a file is modified
  }
}

//... closeTab, renderTabs are unchanged...

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMIT (MODIFIED doCommit to trigger VFS update)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//... openCommitModal is unchanged...

async function doCommit(){
  if(!activeTab||!curRepo)return;
  const msg=document.getElementById('commit-msg').value.trim()||`Update ${activeTab.path}`;
  const[owner,repo]=curRepo.split('/');
  if(editor)activeTab.content=editor.getValue();
  const encoded=btoa(unescape(encodeURIComponent(activeTab.content)));
  closeModal('commit');
  const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${activeTab.path}`,{
    method:'PUT',
    headers:{...ghH(),'Content-Type':'application/json'},
    body:JSON.stringify({message:msg,content:encoded,sha:activeTab.sha,branch:curBranch})
  });
  if(r.ok){
    const d=await r.json();activeTab.sha=d.content.sha;activeTab.mod=false;
    renderTabs();document.getElementById('commit-btn').style.display='none';
    notify(`Committed: ${activeTab.path}`,'s');
    await updateVFS(); // Update VFS after successful commit
  }else{
    const err=await r.json();notify('Commit failed: '+err.message,'e');
  }
}

//... All other functions (AI, UI, Resize, init) are unchanged below this point...
// Ensure you have the full, unchanged functions for the rest of your script.
</script>
</body>
</html>
