<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Web Editor</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-light: #252526;
            --border-color: #333;
            --accent-color: #007acc;
            --text-color: #ccc;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
       .main-container {
            display: flex;
            flex-grow: 1;
        }
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        #login-screen h1 {
            font-size: 2.5em;
            color: #fff;
        }
        #login-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        #login-button:hover {
            background-color: #005a9e;
        }
        #app-container {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
        }
        header h2 {
            margin: 0;
            font-size: 1.2em;
        }
       .header-controls button,.header-controls select {
            background-color: #3c3c3c;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
        }
       .header-controls button:hover {
            background-color: #4f4f4f;
        }
        #status {
            font-size: 0.9em;
            margin-left: 15px;
        }
       .content-wrapper {
            display: flex;
            flex-grow: 1;
            height: calc(100% - 50px);
        }
        #file-explorer {
            width: 250px;
            background-color: var(--bg-light);
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }
        #file-explorer ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #file-explorer li {
            padding: 4px;
            cursor: pointer;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #file-explorer li:hover {
            background-color: #37373d;
        }
        #file-explorer li.active {
            background-color: var(--accent-color);
            color: white;
        }
       .editor-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        #editor-container {
            flex-grow: 1;
        }
        #output-console {
            height: 200px;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        #output-console pre {
             margin: 0;
             white-space: pre-wrap;
             word-wrap: break-word;
        }
        #ai-output {
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
            margin-top: 10px;
            color: #a6e22e;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>Cloud Web Editor</h1>
        <p>Edit your GitHub repos with a powerful in-browser IDE.</p>
        <button id="login-button">Login with GitHub</button>
    </div>

    <div id="app-container">
        <header>
            <div style="display: flex; align-items: center;">
                 <h2>Editor</h2>
                 <span id="status">Ready.</span>
            </div>
            <div class="header-controls">
                <span>Repo:</span>
                <select id="repo-select"></select>
                <button id="save-button">Save File</button>
                <button id="run-button">Run Python</button>
                <button id="ai-button">Ask AI</button>
                <button id="logout-button">Logout</button>
            </div>
        </header>
        <div class="content-wrapper">
            <div id="file-explorer">
                <ul id="file-list"></ul>
            </div>
            <div class="editor-area">
                <div id="editor-container"></div>
                <div id="output-console">
                    <pre id="output-pre">Console output will appear here...</pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
        env.allowLocalModels = false;
        
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://uvslkqxtkortoiacmknw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2c2xrcXh0a29ydG9pYWNta253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDk4NzI0NTIsImV4cCI6MjAyNTQ0ODQ1Mn0.Rt0s4x2i4Y_N-J6xL4AZ361vEK075p7L9y1h2iM5aXo';

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const repoSelect = document.getElementById('repo-select');
        const fileList = document.getElementById('file-list');
        const saveButton = document.getElementById('save-button');
        const runButton = document.getElementById('run-button');
        const aiButton = document.getElementById('ai-button');
        const statusEl = document.getElementById('status');
        const outputEl = document.getElementById('output-pre');

        // --- STATE ---
        let supabase;
        let monacoEditor;
        let pyodide;
        let session = null;
        let currentFile = null;
        let ai_pipe = null;

        // --- INITIALIZATION ---
        async function main() {
            // 1. Initialize Supabase
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // 2. Initialize Monaco Editor
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], () => {
                monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                    theme: 'vs-dark',
                    language: 'python',
                    automaticLayout: true
                });
            });

            // 3. Initialize Pyodide
            setStatus('Loading Python runtime...');
            pyodide = await loadPyodide();
            setStatus('Python runtime loaded.');
            
            // 4. Initialize AI
            setStatus('Loading AI model...');
            try {
                ai_pipe = await pipeline('text-generation', 'codellama/CodeLlama-7b-hf', {
                    quantized: true,
                    progress_callback: (data) => {
                       if (data.status === 'progress') {
                           setStatus(`AI model loading: ${Math.round(data.progress)}%`);
                       }
                    }
                });
                setStatus('AI Ready. Select a file.');
            } catch(e) {
                setStatus('AI model failed to load. AI features disabled.');
                console.error("AI Error:", e);
                aiButton.disabled = true;
            }

            // 5. Handle Auth
            const { data } = await supabase.auth.getSession();
            session = data.session;
            updateUI();

            supabase.auth.onAuthStateChange((_event, newSession) => {
                session = newSession;
                updateUI();
            });

            // 6. Bind Events
            loginButton.onclick = handleLogin;
            logoutButton.onclick = handleLogout;
            repoSelect.onchange = handleRepoSelect;
            saveButton.onclick = saveCurrentFile;
            runButton.onclick = runCode;
            aiButton.onclick = runAI;
        }

        // --- UI & AUTH LOGIC ---
        function updateUI() {
            if (session) {
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                loadUserRepos();
            } else {
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                currentFile = null;
            }
        }

        function handleLogin() {
            supabase.auth.signInWithOAuth({ provider: 'github', options: { scopes: 'repo' } });
        }

        function handleLogout() {
            supabase.auth.signOut();
        }
        
        function setStatus(text) {
            statusEl.textContent = text;
        }

        function logToConsole(text, type = 'log') {
             if (type === 'ai') {
                const aiOutput = document.createElement('pre');
                aiOutput.id = 'ai-output';
                aiOutput.textContent = `ðŸ¤– AI Assistant:\n${text}`;
                outputEl.appendChild(aiOutput);
             } else {
                 outputEl.textContent = text;
             }
             outputEl.scrollTop = outputEl.scrollHeight;
        }

        // --- GITHUB API LOGIC ---
        async function githubApiFetch(endpoint) {
            if (!session) throw new Error("Not authenticated");
            const GITHUB_API = 'https://api.github.com';
            const response = await fetch(`${GITHUB_API}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${session.provider_token}` }
            });
            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(`GitHub API Error: ${err.message}`);
            }
            return response.json();
        }

        async function loadUserRepos() {
            try {
                setStatus('Loading repositories...');
                const repos = await githubApiFetch('/user/repos?sort=pushed&per_page=100');
                repoSelect.innerHTML = '<option>Select a repository...</option>';
                repos.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.full_name;
                    option.textContent = repo.full_name;
                    repoSelect.appendChild(option);
                });
                setStatus('Ready. Select a repository.');
            } catch (error) {
                setStatus(`Error: ${error.message}`);
            }
        }

        async function handleRepoSelect() {
            const repoName = repoSelect.value;
            if (!repoName || repoName === 'Select a repository...') return;
            try {
                setStatus(`Fetching files for ${repoName}...`);
                const files = await githubApiFetch(`/repos/${repoName}/contents/`);
                fileList.innerHTML = '';
                files.forEach(file => {
                     const li = document.createElement('li');
                     li.textContent = file.name;
                     li.dataset.path = file.path;
                     li.dataset.sha = file.sha;
                     li.dataset.repo = repoName;
                     li.onclick = () => handleFileSelect(li);
                     fileList.appendChild(li);
                });
                setStatus(`Ready. Select a file from ${repoName}.`);
            } catch (error) {
                 setStatus(`Error: ${error.message}`);
            }
        }

        async function handleFileSelect(liElement) {
             try {
                currentFile = {
                    path: liElement.dataset.path,
                    sha: liElement.dataset.sha,
                    repo: liElement.dataset.repo
                };
                
                document.querySelectorAll('#file-list li').forEach(li => li.classList.remove('active'));
                liElement.classList.add('active');

                setStatus(`Loading ${currentFile.path}...`);
                const fileData = await githubApiFetch(`/repos/${currentFile.repo}/git/blobs/${currentFile.sha}`);
                const fileContent = atob(fileData.content);
                monacoEditor.setValue(fileContent);
                setStatus(`Editing ${currentFile.path}.`);
             } catch(error) {
                 setStatus(`Error: ${error.message}`);
             }
        }

        async function saveCurrentFile() {
            if (!currentFile) {
                setStatus("No file selected to save.");
                return;
            }
            try {
                setStatus(`Saving ${currentFile.path}...`);
                const content = monacoEditor.getValue();
                const encodedContent = btoa(content);

                const GITHUB_API = 'https://api.github.com';
                const endpoint = `${GITHUB_API}/repos/${currentFile.repo}/contents/${currentFile.path}`;
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                         'Authorization': `Bearer ${session.provider_token}`,
                         'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `feat: update ${currentFile.path} via web editor`,
                        content: encodedContent,
                        sha: currentFile.sha // Important: SHA is required to update an existing file
                    })
                });
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message);
                }

                // Update the file's SHA to the new one from the commit
                currentFile.sha = result.content.sha;
                document.querySelector(`li[data-path="${currentFile.path}"]`).dataset.sha = result.content.sha;

                setStatus(`Successfully saved ${currentFile.path}!`);
            } catch(error) {
                setStatus(`Save failed: ${error.message}`);
            }
        }
        
        // --- EXECUTION & AI ---
        async function runCode() {
            if (!pyodide) {
                logToConsole("Pyodide is not loaded yet.");
                return;
            }
             setStatus("Running Python code...");
             logToConsole("Executing...");
            try {
                const code = monacoEditor.getValue();
                // Capture stdout
                pyodide.globals.set('__old_print__', console.log);
                let stdout = "";
                console.log = (msg) => stdout += msg + "\n";

                await pyodide.loadPackagesFromImports(code);
                let result = await pyodide.runPythonAsync(code);
                
                console.log = pyodide.globals.get('__old_print__'); // Restore
                
                let output = stdout;
                if(result!== undefined) {
                    output += `\nReturn value: ${result}`;
                }
                logToConsole(output || "[No output]");
                setStatus("Execution finished.");
            } catch (err) {
                logToConsole(`Error: ${err}`);
                setStatus("Execution failed.");
            }
        }

        async function runAI() {
            if (!ai_pipe) {
                logToConsole("AI is not available.");
                return;
            }
            if (!monacoEditor.getValue()) {
                 logToConsole("There is no code to analyze.");
                 return;
            }
            
            setStatus('AI is thinking...');
            try {
                 const code = monacoEditor.getValue();
                 const prompt = `You are a helpful coding assistant. Please explain the following Python code, identify potential bugs, or suggest improvements.\n\n---\n\n${code}\n\n---\n\nAssistant:`;
                 
                 const result = await ai_pipe(prompt, {
                     max_new_tokens: 150,
                     no_repeat_ngram_size: 3
                 });
                 const aiResponse = result[0].generated_text.split('Assistant:')[1].trim();
                 logToConsole(aiResponse, 'ai');
                 setStatus('AI analysis complete.');

            } catch (error) {
                setStatus('AI task failed.');
                console.error("AI execution error:", error);
            }
        }
        
        main();
    </script>
</body>
</html>
